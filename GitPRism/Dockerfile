# ğŸ”¹ 1. ë¹Œë“œ ë‹¨ê³„ (Builder Stage)
FROM openjdk:17-jdk-slim as builder

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# Gradle Wrapperì™€ í”„ë¡œì íŠ¸ ê´€ë ¨ íŒŒì¼ì„ ë¨¼ì € ë³µì‚¬
COPY gradlew ./
COPY gradle/ gradle/
COPY build.gradle settings.gradle ./

# Gradle ì¢…ì†ì„± ìºì‹± (í•„ìˆ˜ ì˜ì¡´ì„±ë§Œ ë¨¼ì € ë‹¤ìš´ë¡œë“œ)
RUN chmod +x gradlew
RUN ./gradlew dependencies --no-daemon || true

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬ ë° ë¹Œë“œ
COPY . .
RUN ./gradlew bootJar --no-daemon

# ğŸ”¹ 2. ì‹¤í–‰ ë‹¨ê³„ (Final Stage)
FROM openjdk:17-jdk-slim

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ë¹Œë“œëœ JAR íŒŒì¼ ë³µì‚¬ (ì •í™•í•œ íŒŒì¼ëª… ì‚¬ìš©)
COPY --from=builder /app/build/libs/*.jar app.jar

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8080

# ì‹¤í–‰ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (í•„ìš”í•˜ë©´ ì¶”ê°€ ê°€ëŠ¥)
ENV SPRING_PROFILES_ACTIVE=prod

# ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ JAR íŒŒì¼ ì‹¤í–‰
CMD ["java", "-jar", "app.jar"]
